databases:
  # PostgreSQL Database for Yaci Store
  # Using basic-256mb plan (free tier may not be available)
  - name: govtwool-database
    databaseName: yaci_store
    plan: basic-256mb
    user: yaci_store_user

services:
  # Backend API Service
  - type: web
    name: govtwool-backend
    env: rust
    region: oregon
    rootDir: backend
    buildCommand: cargo build --release
    startCommand: ./target/release/govtwool-backend
    healthCheckPath: /health
    envVars:
      # Database Configuration (auto-linked to PostgreSQL database)
      - key: DATABASE_URL
        fromDatabase:
          name: govtwool-database
          property: connectionString
      - key: DB_HOST
        fromDatabase:
          name: govtwool-database
          property: host
      - key: DB_PORT
        fromDatabase:
          name: govtwool-database
          property: port
      - key: DB_NAME
        fromDatabase:
          name: govtwool-database
          property: database
      - key: DB_USER
        fromDatabase:
          name: govtwool-database
          property: user
      - key: DB_PASSWORD
        fromDatabase:
          name: govtwool-database
          property: password
      
      # Server Configuration
      - key: PORT
        value: 8080
      
      # Cache Configuration
      - key: CACHE_ENABLED
        value: "true"
      - key: CACHE_MAX_ENTRIES
        value: "10000"
      
      # GovTools Configuration (optional)
      - key: GOVTOOLS_ENABLED
        value: "false"
      - key: GOVTOOLS_BASE_URL
        value: https://be.preview.gov.tools
      
      # CORS Configuration
      - key: CORS_ORIGINS
        value: "*"
      
      # Legacy Blockfrost/Koios (optional, not used with Yaci Store)
      - key: BLOCKFROST_NETWORK
        value: preview
      - key: BLOCKFROST_API_KEY
        sync: false
      - key: KOIOS_BASE_URL
        sync: false

  # Yaci Store Indexer (Background Worker)
  - type: worker
    name: govtwool-indexer
    env: docker
    region: oregon
    rootDir: indexer
    dockerfilePath: ./Dockerfile
    dockerContext: .
    envVars:
      # Database Configuration (auto-linked to PostgreSQL database)
      - key: SPRING_DATASOURCE_URL
        fromDatabase:
          name: govtwool-database
          property: connectionString
      - key: SPRING_DATASOURCE_USERNAME
        fromDatabase:
          name: govtwool-database
          property: user
      - key: SPRING_DATASOURCE_PASSWORD
        fromDatabase:
          name: govtwool-database
          property: password
      
      # Cardano Network Configuration
      - key: STORE_CARDANO_PROTOCOL_MAGIC
        value: "2"
      - key: STORE_CARDANO_HOST
        value: preview-node.play.dev.cardano.org
      - key: STORE_CARDANO_PORT
        value: "3001"
      
      # Performance Settings
      - key: STORE_PARALLEL_PROCESSING
        value: "true"
      - key: STORE_VIRTUAL_THREADS_ENABLED
        value: "true"

