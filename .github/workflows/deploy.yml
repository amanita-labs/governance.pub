name: Deploy

on:
  push:
    branches:
      - main # Auto-deploy on pushes to main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production

# Prevent concurrent deployments
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  deploy-frontend:
    name: Deploy Frontend to Vercel
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: ðŸ“¥ Install Vercel CLI
        run: npm install --global vercel@latest

      - name: ðŸš€ Deploy to Vercel
        uses: amondnet/vercel-action@v25
        id: vercel-deploy
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: 'deploy --prod --confirm'
          working-directory: frontend

      - name: âœ… Frontend Deployment Summary
        run: |
          echo "## ðŸš€ Frontend Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform**: Vercel" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Deployed successfully" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ steps.vercel-deploy.outputs.preview-url }}" ]; then
            echo "- **Preview URL**: ${{ steps.vercel-deploy.outputs.preview-url }}" >> $GITHUB_STEP_SUMMARY
          fi

  # deploy-backend:
  #   name: Deploy Backend to Render
  #   runs-on: ubuntu-latest
  #   environment: production
    
  #   steps:
  #     - name: ðŸ“¥ Checkout repository
  #       uses: actions/checkout@v4

  #     - name: ðŸ¦€ Setup Rust
  #       uses: dtolnay/rust-toolchain@stable
  #       with:
  #         toolchain: stable

  #     - name: ðŸ’¾ Cache Rust dependencies
  #       uses: actions/cache@v4
  #       with:
  #         path: |
  #           ~/.cargo/bin/
  #           ~/.cargo/registry/index/
  #           ~/.cargo/registry/cache/
  #           ~/.cargo/git/db/
  #           backend/target/
  #         key: ${{ runner.os }}-rust-${{ hashFiles('backend/Cargo.lock') }}
  #         restore-keys: |
  #           ${{ runner.os }}-rust-

  #     - name: ðŸ” Verify backend builds
  #       working-directory: backend
  #       env:
  #         BLOCKFROST_API_KEY: ${{ secrets.BLOCKFROST_API_KEY }}
  #         BLOCKFROST_NETWORK: ${{ secrets.BLOCKFROST_NETWORK || 'mainnet' }}
  #         KOIOS_BASE_URL: ${{ secrets.KOIOS_BASE_URL || 'https://preview.koios.rest/api/v1' }}
  #       run: cargo check --all-targets

  #     - name: ðŸš€ Trigger Render Deployment
  #       uses: johnbeynon/render-deploy-action@v0.0.8
  #       with:
  #         service-id: ${{ secrets.RENDER_SERVICE_ID }}
  #         api-key: ${{ secrets.RENDER_API_KEY }}

  #     - name: âœ… Backend Deployment Summary
  #       run: |
  #         echo "## ðŸ¦€ Backend Deployment Summary" >> $GITHUB_STEP_SUMMARY
  #         echo "- **Platform**: Render" >> $GITHUB_STEP_SUMMARY
  #         echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
  #         echo "- **Branch**: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
  #         echo "- **Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
  #         echo "- **Status**: âœ… Deployment triggered successfully" >> $GITHUB_STEP_SUMMARY
  #         echo "" >> $GITHUB_STEP_SUMMARY
  #         echo "**Note**: Render deployments may take a few minutes to complete. Check the Render dashboard for deployment status." >> $GITHUB_STEP_SUMMARY

  # deployment-complete:
  #   name: Deployment Complete
  #   runs-on: ubuntu-latest
  #   needs: [deploy-frontend, deploy-backend]
  #   if: always()
    
  #   steps:
  #     - name: ðŸ“Š Deployment Status
  #       run: |
  #         echo "## ðŸŽ‰ Deployment Pipeline Complete" >> $GITHUB_STEP_SUMMARY
  #         echo "" >> $GITHUB_STEP_SUMMARY
  #         echo "### Frontend (Vercel)" >> $GITHUB_STEP_SUMMARY
  #         if [ "${{ needs.deploy-frontend.result }}" == "success" ]; then
  #           echo "âœ… **Status**: Deployed successfully" >> $GITHUB_STEP_SUMMARY
  #         else
  #           echo "âŒ **Status**: Deployment failed" >> $GITHUB_STEP_SUMMARY
  #         fi
  #         echo "" >> $GITHUB_STEP_SUMMARY
  #         echo "### Backend (Render)" >> $GITHUB_STEP_SUMMARY
  #         if [ "${{ needs.deploy-backend.result }}" == "success" ]; then
  #           echo "âœ… **Status**: Deployment triggered successfully" >> $GITHUB_STEP_SUMMARY
  #         else
  #           echo "âŒ **Status**: Deployment failed" >> $GITHUB_STEP_SUMMARY
  #         fi
  #         echo "" >> $GITHUB_STEP_SUMMARY
  #         echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
  #         echo "**Branch**: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
